name: vms-resident-mobile-app-iOS

on:
  workflow_dispatch:

jobs:
  build-ios:
    name: Build and Sign iOS App
    runs-on: macos-latest

    steps:
      # 1️⃣ Checkout your code
      - uses: actions/checkout@v3

      # 2️⃣ Setup Flutter
      - uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          architecture: x64

      # 3️⃣ Get dependencies
      - run: flutter pub get

      # 4️⃣ Update CocoaPods
      - run: pod repo update
        working-directory: ios

      # 5️⃣ Import Apple signing certificate (.p12)
      - name: Import Apple Code Signing Certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_P12 }}
          p12-password: ${{ secrets.APPLE_P12_PASSWORD }}

      # 6️⃣ Install provisioning profile manually
      - name: Install provisioning profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.APPLE_PROVISION_PROFILE }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision

      # 7️⃣ Build signed iOS .ipa
      - name: Build signed iOS release
        run: flutter build ipa --release

      # 8️⃣ Upload .ipa to GitHub Release (optional)
      - name: Upload signed .ipa to GitHub Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/ios/ipa/*.ipa
          tag: v1.0
          overwrite: true
          body: "Signed iOS .ipa build ready for Diawi"
